<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Güvenlik Kargo Bildirim</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Montserrat',sans-serif; background:#1f2a38; color:#ecf0f1; }
header { text-align:center; padding:15px; font-size:1.5rem; font-weight:600; position:relative; }
.container { max-width:600px; margin:0 auto; padding:15px; }
.search-bar { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px; }
.search-bar input { flex:1; padding:8px; border-radius:8px; border:none; text-transform:uppercase; }
.kargo-list { display:flex; flex-direction:column; gap:10px; max-height:70vh; overflow-y:auto; }
.kargo-card { background:rgba(255,255,255,0.1); padding:12px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
.kargo-info { flex:1; min-width:180px; }
.kargo-buttons { display:flex; gap:6px; margin-top:6px; flex-wrap:wrap; }
button { padding:6px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
.deliver-btn { background:#27ae60; color:#fff; }
.deliver-btn:hover { background:#2ecc71; }
.call-btn { background:#2980b9; color:#fff; }
.call-btn:hover { background:#3498db; }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:9999; flex-direction:column; justify-content:center; align-items:center; padding:20px; color:#fff; border-radius:12px; }
.modal-content { background:#34495e; padding:20px; border-radius:12px; text-align:center; max-width:400px; }
.modal-buttons { display:flex; gap:10px; justify-content:center; margin-top:15px; flex-wrap:wrap; }
.modal button { min-width:100px; }
.logout-btn { position:absolute; right:20px; top:15px; padding:6px 12px; border:none; border-radius:8px; background:#c0392b; color:#fff; cursor:pointer; font-size:14px; }
.logout-btn:hover { background:#e74c3c; }
.countdown { color:#f1c40f; font-size:0.9rem; margin-top:4px; }
</style>
</head>
<body>

<header>
  Güvenlik Kargo Bildirim
  <button class="logout-btn" id="logoutBtn">Çıkış</button>
</header>

<div class="container">
  <div class="search-bar">
    <input type="text" id="searchApartment" placeholder="DAİRE NO ARA">
    <input type="text" id="searchCompany" placeholder="FİRMA ARA">
  </div>
  <div class="kargo-list" id="kargoList">
    <p>Veriler yükleniyor...</p>
  </div>
</div>

<div class="modal" id="confirmModal">
  <div class="modal-content">
    <div id="modalText"></div>
    <div class="modal-buttons">
      <button id="confirmYes" class="deliver-btn">EVET</button>
      <button id="confirmNo" class="call-btn">HAYIR</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, update } 
from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

/* === QR ile gelen Firebase bilgileri === */
const siteID = localStorage.getItem("siteID");
const siteConfigStr = localStorage.getItem("siteConfig");

if (!siteID || !siteConfigStr) {
  alert("Site bağlantısı yok. Lütfen QR kodu tekrar okutunuz.");
  window.location.href = "index.html";
}

const siteConfig = JSON.parse(siteConfigStr);

/* === Aynı site için tek Firebase app === */
let app = getApps().find(a => a.name === `siteApp-${siteID}`);
if (!app) {
  app = initializeApp(siteConfig, `siteApp-${siteID}`);
}

const db = getDatabase(app);



const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
if(!currentUser || !currentUser.username){
  alert("Bu sayfaya sadece güvenlik girebilir!");
  window.location.href="security-dashboard.html";
}

document.getElementById('logoutBtn').onclick = () => {
  window.location.href='guvenlik.html';
};

const kargoList = document.getElementById('kargoList');
const searchApartment = document.getElementById('searchApartment');
const searchCompany = document.getElementById('searchCompany');
const confirmModal = document.getElementById('confirmModal');
const modalText = document.getElementById('modalText');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');

let selectedKargo = null;
const countdownIntervals = {};

const kargoRef = ref(db,'kargoDeliveries');

onValue(kargoRef, snapshot => {
  const val = snapshot.val();
  kargoList.innerHTML = '';
  if(!val){
    kargoList.innerHTML = '<p>Henüz bildirim yok.</p>';
    return;
  }

  // Yeni ve teslim alınanları ayrı sıralama
  const newKargos = [];
  const receivedKargos = [];

  Object.keys(val).forEach(apartmentKey => {
    const apartmentData = val[apartmentKey];
    if(!apartmentData) return;

    Object.keys(apartmentData).forEach(deliveryId => {
      const item = {...apartmentData[deliveryId], id: deliveryId};

      // Sadece kendi teslim aldığı veya henüz teslim almadığı kargolar
      if(item.status !== 'Teslim Alındı' || item.receivedBy === currentUser.username){
        if(item.status === 'Teslim Alındı'){
          receivedKargos.push({apartmentKey, ...item});
        } else {
          newKargos.push({apartmentKey, ...item});
        }
      }
    });
  });

  // Yeni kargolar en üste
  [...newKargos, ...receivedKargos].forEach(item => createKargoCard(item));

  applyFilter();
});

// Kart oluşturma fonksiyonu
function createKargoCard(item){
  const div = document.createElement('div');
  div.classList.add('kargo-card');

  const info = document.createElement('div');
  info.classList.add('kargo-info');

  let statusText = item.status === 'Teslim Alındı' ? `Teslim Alan: ${item.receivedBy}` : item.status;
  info.innerHTML = `<strong>${item.company}</strong> (${item.deliveryCode}) - Daire ${item.apartment}<br>Not: ${item.note||'-'}<br>${statusText}<div class="countdown" id="countdown-${item.id}"></div>`;
  div.appendChild(info);

  const buttons = document.createElement('div');
  buttons.classList.add('kargo-buttons');

  // Teslim alma butonu
  if(item.status!=='Teslim Alındı'){
    const deliverBtn = document.createElement('button');
    deliverBtn.classList.add('deliver-btn');
    deliverBtn.innerText='Teslim Aldım';
    deliverBtn.onclick = () => openConfirmModal(item.apartmentKey, item);
    buttons.appendChild(deliverBtn);
  }

  // Telefon varsa arama
  if(item.phone && item.phone.trim()!==''){
    const callBtn = document.createElement('button');
    callBtn.classList.add('call-btn');
    callBtn.innerText='Ara';
    callBtn.onclick = () => { window.location.href = `tel:${item.phone}`; };
    buttons.appendChild(callBtn);
  }

  div.appendChild(buttons);
  kargoList.appendChild(div);

  // Teslim aldıysa geri sayım başlat
  if(item.status==='Teslim Alındı' && item.receivedBy===currentUser.username){
    if(!item.countdownStart){
      update(ref(db,`kargoDeliveries/${item.apartmentKey}/${item.id}`),{
        countdownStart: new Date().toISOString()
      });
      item.countdownStart = new Date().toISOString();
    }
    startCountdown(item.id, item.countdownStart, div);
  }
}

// Modal
function openConfirmModal(apartmentKey, item){
  selectedKargo = {apartmentKey, ...item};
  modalText.innerText = `Daire ${item.apartment}'ın ${item.company} firmasından gelen kargosunu teslim aldığınızı onaylıyor musunuz?`;
  confirmModal.style.display='flex';
}

confirmYes.onclick = () => {
  if(!selectedKargo) return;
  const path = `kargoDeliveries/${selectedKargo.apartmentKey}/${selectedKargo.id}`;
  update(ref(db,path),{
    status:'Teslim Alındı',
    receivedBy: currentUser.username,
    countdownStart: new Date().toISOString()
  });
  confirmModal.style.display='none';
  selectedKargo = null;
}

confirmNo.onclick = () => {
  confirmModal.style.display='none';
  selectedKargo = null;
}

// Countdown 24 saat, DOM'dan kaldırır ama Firebase'den silmez
function startCountdown(kargoId, countdownStart, div){
  const countdownDiv = div.querySelector(`#countdown-${kargoId}`);
  const endTime = new Date(countdownStart).getTime() + 24*60*60*1000;

  if(countdownIntervals[kargoId]) clearInterval(countdownIntervals[kargoId]);

  countdownIntervals[kargoId] = setInterval(() => {
    const now = new Date().getTime();
    const distance = endTime - now;

    if(distance<=0){
      clearInterval(countdownIntervals[kargoId]);
      countdownDiv.innerText = "Süre Bittiğinde Bildirim Görünmeyecek";
      div.remove(); // Sadece DOM'dan kaldır
      return;
    }

    const hours = Math.floor(distance / (1000*60*60));
    const minutes = Math.floor((distance % (1000*60*60)) / (1000*60));
    const seconds = Math.floor((distance % (1000*60)) / 1000);

    countdownDiv.innerText = `Süre Bittiğinde Bildirim Silinecek: ${hours} saat ${minutes} dakika ${seconds} saniye`;
  },1000);
}

// Arama filtresi
searchApartment.addEventListener('input',applyFilter);
searchCompany.addEventListener('input',applyFilter);

function applyFilter(){
  const ap = searchApartment.value.toUpperCase();
  const co = searchCompany.value.toUpperCase();
  const cards = kargoList.children;
  for(let card of cards){
    const infoText = card.querySelector('.kargo-info').innerText.toUpperCase();
    card.style.display = (infoText.includes(ap) && infoText.includes(co)) ? 'flex' : 'none';
  }
}
</script>
</body>
</html>

